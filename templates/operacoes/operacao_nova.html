{% extends "base.html" %}
{% block title %}Nova Opera√ß√£o{% endblock %}

{% block content %}

<style>

  html, body {
  height: 100vh;
  overflow-y: scroll;
  }

  .wrap-compact {
    max-width: 560px;
    padding-bottom: 9rem;  /* espa√ßo para o menu fixo do rodap√© */
  }

  .card-compact { padding: .75rem !important; }
  .h5-compact   { margin: .25rem 0 .5rem 0; font-size: 1.05rem; }
  .mb-compact   { margin-bottom: .5rem !important; }
  .g-compact    { --bs-gutter-x: .5rem; --bs-gutter-y: .25rem; }
  label.form-label { margin-bottom: .125rem; font-size: .9rem; }
  .btn-sm-tight { padding: .25rem .5rem; font-size: .85rem; }

  .form-control, .form-select, select, input[type="text"], input[type="date"] {
    height: calc(1.5em + .5rem + 2px);
    padding: .25rem .5rem;
    font-size: .9rem;
    line-height: 1.25;
  }

  .total-linha { background:#f6f7f8; }

  .campo-qtd input {
    min-width: 60px;
    text-align: center;
  }

  .form-control, .form-select {
      font-size: 0.82rem;
  }

  .campo-qtd input,
  .campo-preco input,
  .campo-total input,
  #qtd_equivalente_preview {
      font-size: 0.80rem !important;
  }

  input[name$="-unit_price"] { font-size: 0.80rem !important; }
  input[name$="-qty"]         { font-size: 0.80rem !important; }
  .total-linha                { font-size: 0.80rem !important; }

</style>

<div class="container my-3 wrap-compact" style="min-height: 100vh; overflow-y: auto;">
  <h3 class="mb-3 text-center" style="font-weight:700;">Nova Opera√ß√£o</h3>

  <!-- Sele√ß√£o (GET) -->
  <form id="cab-form" method="get" class="card card-compact mb-2">

    <div class="mb-compact">
      <label class="form-label">Vendedor</label>
      {{ cab_form.seller }}
      <div class="mt-1">
        <a href="{% url 'vendedor_create' %}?next={{ request.get_full_path|urlencode }}">+ Cadastrar vendedor</a>
      </div>
    </div>

    <div class="mb-1">
      <label class="form-label d-block">Tipo</label>
      <div class="d-flex gap-3"><div class="d-flex gap-3 align-items-center" style="flex-wrap:nowrap;">
        {% for radio in cab_form.tipo %}
        <label class="d-flex align-items-center gap-1">
            {{ radio.tag }} {{ radio.choice_label }}
        </label>
        {% endfor %}
      </div>
    </div>
  </form>

  {% if mostrar_remessa %}
  <!-- Remessa (POST) -->
  <form method="post" class="card card-compact mb-2" id="form-remessa">
    {% csrf_token %}
    <input type="hidden" name="seller" value="{{ seller_id }}">
    <input type="hidden" name="tipo" value="{{ tipo }}">

    <h5 class="h5-compact">Dados da Remessa</h5>

    <div class="mb-2" style="max-width: 220px;">
      <label class="form-label">Data</label>
      {{ rem_form.date }}
    </div>

    {{ formset.management_form }}

    <div id="itens-container">
      {% for f in formset.forms %}
      <div class="row g-compact align-items-end mb-3 linha-item">

        <div class="col-12">
          <label class="form-label">Produto</label>
          {{ f.product }}
        </div>

        <div class="col-4 campo-qtd mt-2">
          <label class="form-label">Qtd</label>
          {{ f.qty }}
        </div>

        <div class="col-4 mt-2">
          <label class="form-label">Pre√ßo</label>
          {{ f.unit_price }}
        </div>

        <div class="col-4 mt-2">
          <label class="form-label">Total</label>
          <input class="form-control total-linha" readonly>
        </div>

      </div>
      {% endfor %}
    </div>

    <button type="button" id="btn-add-item" class="btn btn-secondary btn-sm-tight w-100">+ Adicionar item</button>

    <div class="mt-2 d-flex gap-2 mb-5" style="margin-bottom: 5rem;">
      <button class="btn btn-success btn-sm-tight flex-fill">Salvar</button>
      <a href="{% url 'vendedores_list' %}" class="btn btn-link btn-sm-tight flex-fill text-center">Cancelar</a>
    </div>
  </form>
  {% endif %}

  {% if mostrar_recebimento %}
  <!-- Recebimento (POST) -->
  <form method="post" class="card card-compact mb-2" id="form-recebimento">
    {% csrf_token %}
    <input type="hidden" name="seller" value="{{ seller_id }}">
    <input type="hidden" name="tipo" value="{{ tipo }}">

    <h5 class="h5-compact">Recebimento</h5>

    <!-- üìå Data agora em linha separada -->
    <div class="mb-2" style="max-width: 220px;">
      <label class="form-label">Data</label>
      {{ rec_form.date }}
    </div>

    <!-- üìå Valor + Quantidade lado a lado -->
    <div class="row g-compact align-items-end mb-2">
      <div class="col-6">
        <label class="form-label">Valor (R$)</label>
        {{ rec_form.amount }}
      </div>
      <div class="col-6">
        <label class="form-label">Qtd Recebida</label>
        <input id="qtd_equivalente_preview" class="form-control" readonly>
      </div>
    </div>

    <div class="mt-2 d-flex gap-2">
      <button class="btn btn-success btn-sm-tight flex-fill">Salvar</button>
      <a href="{% url 'vendedores_list' %}" class="btn btn-link btn-sm-tight flex-fill text-center">Cancelar</a>
    </div>
  </form>
  {% endif %}

</div>

<script>
(function(){

  // ---------- helpers formato BR ----------
  function parseBR(s){
    if (!s) return 0;
    return parseFloat(String(s).replace(/\./g,'').replace(',','.')) || 0;
  }
  function fmtBR(n, dec){
    return (isFinite(n) ? n : 0).toLocaleString('pt-BR', {
      minimumFractionDigits: dec, maximumFractionDigits: dec
    });
  }
  function wireBRInput(el, dec){
    if(!el) return;
    el.addEventListener('input', function(){
      this.value = this.value.replace(/[^\d,\.]/g,'').replace(/(\,.*)\,/g,'$1');
    });
    el.addEventListener('blur', function(){
      const v = parseBR(this.value);
      this.value = fmtBR(v, dec);
    });
  }
  function normalizeOnSubmit(form){
    if(!form) return;
    form.addEventListener('submit', function(){
      form.querySelectorAll('.br-0,.br-2').forEach(function(el){
        const v = parseBR(el.value);
        el.value = (el.classList.contains('br-0') ? String(Math.round(v)) : String(v));
      });
    });
  }

  // auto-submit ao trocar vendedor/tipo
  const cabForm = document.getElementById('cab-form');
  if (cabForm) {
    const gatilhos = cabForm.querySelectorAll('select[name="seller"], input[name="tipo"]');
    gatilhos.forEach(el=>{
      el.addEventListener('change', ()=> cabForm.submit());
    });
  }

  // -------- Remessa: totais e m√°scara --------
  function wireLinha(row){
    const qty   = row.querySelector('input[name$="-qty"]');
    const price = row.querySelector('input[name$="-unit_price"]');
    const total = row.querySelector('.total-linha');

    if(qty){ qty.classList.add('form-control','br-0'); wireBRInput(qty, 0); }
    if(price){ price.classList.add('form-control','br-2'); wireBRInput(price, 2); }
    if(total){ total.classList.add('form-control'); }

    function calc(){
      const q = parseBR(qty && qty.value);
      const p = parseBR(price && price.value);
      if(total) total.value = fmtBR(q * p, 2);
    }
    if(qty)   qty.addEventListener('input', calc);
    if(price) price.addEventListener('input', calc);
    if(qty)   qty.addEventListener('blur', calc);
    if(price) price.addEventListener('blur', calc);
  }

  document.querySelectorAll('.linha-item').forEach(wireLinha);

  normalizeOnSubmit(document.getElementById('form-remessa'));

  // -------- Recebimento: m√°scara + preview --------
  const amountInput = document.querySelector('#form-recebimento input[name="amount"]');
  const qtdPrev = document.getElementById('qtd_equivalente_preview');

  if(amountInput){
    amountInput.classList.add('form-control','br-2'); wireBRInput(amountInput, 2);
    amountInput.addEventListener('input', function(){
      const v = parseBR(amountInput.value);
      if(qtdPrev){
        qtdPrev.value = fmtBR(v, 2);
        qtdPrev.classList.add('form-control');
      }
    });
    normalizeOnSubmit(document.getElementById('form-recebimento'));
  }

})();
</script>

{% endblock %}
